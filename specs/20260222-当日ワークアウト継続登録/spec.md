# Feature Specification: 当日ワークアウト継続登録

**Feature Branch**: `main`
**Created**: 2026-02-22
**Status**: Draft
**Input**: User description: "当日ワークアウトが存在する場合に+ボタンからそのワークアウトの継続として新しいエクササイズを追加できる機能。Issue: https://github.com/k-negishi/workout-plus/issues/107"

## 背景・コンテキスト

現状、ホーム画面の「+」ボタンは常に新規ワークアウト記録画面を起動する。
当日すでにワークアウトを完了・記録済みの場合でも新規として扱われてしまい、
「続きを記録したい」というユースケースに対応できていない。

1日1ワークアウト制約のもと、「継続登録」として既存ワークアウトに種目を追記できるようにする。

---

## User Scenarios & Testing *(mandatory)*

### User Story 1 - 当日ワークアウト存在時に継続登録する (Priority: P1)

ユーザーが午前中にベンチプレスを記録し、午後に別の種目（デッドリフト等）を追加したい場合、
+ボタンをタップするとシステムが当日のワークアウトを検出し、継続モードで記録画面を開く。
既存の種目・セットはそのまま表示され、新しい種目を末尾に追加できる。

**Why this priority**: 本機能の核心ユースケース。当日ワークアウトが存在する場合の挙動変更が主目的。

**Independent Test**: 当日完了済みワークアウトがある状態で+ボタンをタップし、
既存種目が表示された記録画面が開き、新しい種目を追加して完了できることを確認。

**Acceptance Scenarios**:

1. **Given** 当日完了済みワークアウトが存在する, **When** ホームの+ボタンをタップ, **Then** 継続モードで記録画面が開き、既存の種目とセットが表示される
2. **Given** 継続モードで記録画面が開いている, **When** 新しい種目を選択して追加する, **Then** 既存種目の末尾に新種目が追加される
3. **Given** 継続モードで完了ボタンをタップ, **When** ワークアウトが完了処理される, **Then** 既存ワークアウトに追加された状態で1件として保存される（新規ワークアウトは生成されない）
4. **Given** 当日ワークアウトが存在しない, **When** ホームの+ボタンをタップ, **Then** 従来通り新規記録画面が開く

---

### User Story 2 - 継続モードの状態管理と既存データの保護 (Priority: P2)

継続登録中に誤ってアプリを終了した場合でも、既存の完了済みデータは失われず、
追記中のデータは「記録中（recording）」状態として保持される。

**Why this priority**: データ損失防止。完了済みワークアウトの既存データが継続操作によって壊れてはならない。

**Independent Test**: 継続モードで種目を追加した後にアプリを強制終了し、再起動後に復帰して完了できることを確認。

**Acceptance Scenarios**:

1. **Given** 継続モードで記録中, **When** アプリをバックグラウンドに移動して再起動する, **Then** 継続中のセッションが復元され、追加中の種目が保持されている
2. **Given** 継続モードで記録画面を破棄（discard）する, **When** 破棄を確定する, **Then** 既存の完了済みワークアウトデータは変更されず、追加分のみ削除される
3. **Given** 継続モードで新しい種目のみ追加して完了する, **When** 完了処理が行われる, **Then** 既存種目＋新規種目が1つのワークアウトとして扱われる

---

### User Story 3 - 継続後のサマリー表示 (Priority: P3)

継続登録完了後に表示されるサマリーは、追加した種目のみではなく
その日のワークアウト全体（既存＋追加）を反映する。

**Why this priority**: UX の一貫性。ユーザーがその日のトレーニング全体を確認できる。

**Independent Test**: 継続モードで種目を追加して完了し、サマリー画面にその日の全種目が表示されることを確認。

**Acceptance Scenarios**:

1. **Given** 継続モードで完了する, **When** ワークアウトサマリー画面が表示される, **Then** 既存種目と追加種目の両方がサマリーに含まれる
2. **Given** 継続完了後のサマリー, **When** PR（自己記録更新）がある場合, **Then** 追加した種目のPRも正常に表示される

---

### User Story 4 - ワークアウット詳細画面から継続する (Priority: P2)

ワークアウットを誤って完了してしまったユーザーが、詳細画面から直接続きを記録できる。
当日のワークアウットの詳細画面のみに「続きを記録」ボタンを表示し、タップすると継続モードで記録画面を開く。
過去のワークアウット詳細画面には表示しない（混乱防止）。

**Why this priority**: ユーザーが「編集ボタン」を押して編集モードに入ってしまう導線上の混乱を防ぐ。継続と編集の区別を明確にする。

**Independent Test**: 当日完了済みワークアウットの詳細画面を開き、「続きを記録」ボタンをタップして継続モードが起動することを確認。

**Acceptance Scenarios**:

1. **Given** 当日のワークアウット詳細画面を開いている, **When** 画面を確認する, **Then** 「続きを記録」ボタンが表示されている
2. **Given** 過去のワークアウット詳細画面を開いている, **When** 画面を確認する, **Then** 「続きを記録」ボタンは表示されない
3. **Given** 当日ワークアウット詳細画面で「続きを記録」をタップ, **When** 継続モードが起動する, **Then** +ボタン経由の継続モードと同じ動作になる（既存種目が表示された記録画面が開く）

---

### Edge Cases

- 当日のワークアウトが「記録中（recording）」の状態で中断されている場合: 継続ではなく既存の記録中セッションを復帰させる（既存の復帰ロジックを優先）
- 当日ワークアウトが複数存在する場合（データ不整合）: 最新の完了済みワークアウトを継続対象とする
- 継続モードで追加した種目が0件のまま完了しようとした場合: 完了を防止し「種目を追加してください」と案内する
- 継続モードでの「破棄」は追加分のみ削除し、既存の完了済みデータへの影響なし

---

## Requirements *(mandatory)*

### Functional Requirements

- **FR-001**: システムは+ボタンタップ時に当日完了済みワークアウトの存在を確認しなければならない
- **FR-002**: 当日ワークアウトが存在する場合、システムは継続モードで記録画面を開かなければならない
- **FR-003**: 継続モードでは、既存の種目・セットが記録画面上に表示されなければならない
- **FR-004**: 継続モードで追加した種目・セットは既存ワークアウトに追記される形で保存されなければならない（新規ワークアウトとして保存しない）
- **FR-005**: 当日ワークアウトが存在しない場合は、従来通り新規記録画面を起動しなければならない
- **FR-006**: 継続モードを破棄（discard）した場合、既存の完了済みワークアウトデータは変更されてはならない
- **FR-007**: 継続モードで完了した場合のワークアウトサマリーは既存＋追加の全種目を含まなければならない
- **FR-008**: 1日1ワークアウト制約を維持し、継続登録により新規ワークアウトが生成されてはならない
- **FR-009**: 当日のワークアウット詳細画面には「続きを記録」ボタンを表示し、継続モードの入口を提供しなければならない
- **FR-010**: 過去のワークアウット詳細画面には「続きを記録」ボタンを表示してはならない

### Key Entities

- **Workout**: 1日1件の単一ワークアウト。completed / recording / discarded のステータスを持つ
- **WorkoutExercise**: ワークアウトに紐づく種目。既存のものと新規追加のものが混在する
- **WorkoutSet**: 各種目に紐づくセット（重量・レップ数）

---

## Success Criteria *(mandatory)*

### Measurable Outcomes

- **SC-001**: 当日ワークアウトが存在する場合、+ボタンタップから継続モード記録画面表示まで2秒以内に完了する
- **SC-002**: 継続モードで追加した種目が、完了後のワークアウト詳細画面で確認できる（既存種目と区別なく表示）
- **SC-003**: 継続モードの破棄操作後、既存ワークアウトデータの損失がゼロ（データ整合性100%）
- **SC-004**: アプリ再起動後に継続セッションが正常に復元される（復帰成功率100%）
- **SC-005**: 当日ワークアウト非存在時の従来フローが変更されない（既存テストが全て通過）

---

## 前提条件・仮定

- 「当日」の定義：端末のローカル時刻で0:00〜23:59の範囲
- 「継続対象」は当日の完了済み（completed）ワークアウトの最新1件
- 記録中（recording）のセッションが存在する場合は既存の復帰ロジックを優先する（本機能は干渉しない）
- 継続モードの記録画面は既存の RecordScreen を流用するか、共通化したコンポーネントを使用する（実装詳細は plan フェーズで決定）
- PR（自己記録）の計算ロジックは既存のものをそのまま使用する
