# Feature Specification: 種目選択画面のカスタム並び順設定

**Feature Branch**: `20260223-種目選択カスタム並び順`
**Created**: 2026-02-23
**Status**: Draft
**GitHub Issue**: #141

## User Scenarios & Testing *(mandatory)*

### User Story 1 - 並び替えモーダルで種目の順序を任意に変更する (Priority: P1)

ユーザーが種目選択画面（ExercisePickerScreen）のヘッダー右端にある「⇅」ボタンをタップすると、並び替えモーダルが開く。モーダルには全種目がフラットリストで表示され、ドラッグ＆ドロップで任意の順序に並び替えられる。「保存」ボタンで確定すると`exercises.sort_order`に永続化される。

**Why this priority**: 本機能の核心。並び替えUIと保存が実現できれば単体でユーザー価値を提供できる。

**Independent Test**: 並び替えモーダルを開いてドラッグで順序を変更し、「保存」後に種目選択画面を閉じて再度開いたとき、変更した順序で種目が表示されることを確認できる。

**Acceptance Scenarios**:

1. **Given** 種目選択画面が表示されている, **When** ヘッダー右端の「⇅」ボタンをタップする, **Then** 並び替えモーダルが開き、全種目がフラットリストで表示される
2. **Given** 並び替えモーダルが開いている, **When** 種目行の左端ドラッグハンドル（☰）を長押し→ドラッグする, **Then** 種目が移動し順序が変わる
3. **Given** ドラッグで順序を変更した状態で, **When** 「保存」ボタンをタップする, **Then** モーダルが閉じ、以降の種目選択画面で変更した順序が反映される
4. **Given** 並び替えモーダルが開いている, **When** 「キャンセル」をタップする, **Then** 変更が破棄されてモーダルが閉じ、元の順序が維持される

---

### User Story 2 - 並び順がアプリ再起動後も保持される (Priority: P2)

一度設定した並び順はアプリを再起動しても維持される。`exercises.sort_order`カラムにDBへ永続化されるため、セッションをまたいで並び順が保たれる。

**Why this priority**: P1の自然な拡張。DBへの永続化はP1実装の中で完結するため、別途大きな追加実装は不要。

**Independent Test**: 並び順を変更して「保存」後、アプリを完全に終了して再起動し、種目選択画面を開いたとき変更した順序が維持されていることを確認する。

**Acceptance Scenarios**:

1. **Given** 並び順を変更して保存した状態で, **When** アプリを完全に終了して再起動する, **Then** 種目選択画面に変更した並び順が維持されている
2. **Given** 新しいカスタム種目を作成したとき, **When** 並び替えモーダルを開く, **Then** 新しい種目がリストの末尾に表示される（`MAX(sort_order) + 1`）

---

### User Story 3 - 既存のセクション構造と並び順の共存 (Priority: P3)

種目選択画面では既存の「お気に入り」「マイ種目」「カテゴリ別」セクション構造を維持する。各セクション内の種目が`sort_order`順で表示される。並び替えモーダルはセクション区別なくすべての種目をフラットリストで表示する。

**Why this priority**: P1・P2完成後の仕上げ。既存UIとの整合性担保。

**Independent Test**: お気に入り種目がある状態で並び順を変更・保存後、種目選択画面でお気に入りセクションの種目がsort_order順になっていることを確認する。

**Acceptance Scenarios**:

1. **Given** 並び順を変更・保存した後, **When** 種目選択画面を開く, **Then** お気に入りセクション内の種目がsort_order順で表示される
2. **Given** 並び順を変更・保存した後, **When** 種目選択画面を開く, **Then** マイ種目セクション内の種目がsort_order順で表示される
3. **Given** 並び順を変更・保存した後, **When** 種目選択画面を開く, **Then** カテゴリ別セクション内の種目がsort_order順で表示される

---

### Edge Cases

- 全種目が同じsort_orderを持つ場合（初期状態） → `rowid`順（登録順）で安定ソート
- 新規カスタム種目追加後に並び替えモーダルを開くと新種目がリスト末尾に表示される
- 並び替えモーダルを開いている間に他の操作（種目追加など）は不可（モーダルが前面に表示される）

---

## Requirements *(mandatory)*

### Functional Requirements

- **FR-001**: 種目選択画面（ExercisePickerScreen）のヘッダー右端に「⇅」ボタンを追加すること
- **FR-002**: 「⇅」ボタンタップで並び替えモーダルが開き、全種目のフラットリストが表示されること
- **FR-003**: 各種目行の左端にドラッグハンドル（☰）が表示され、長押し→ドラッグで並び替えられること
- **FR-004**: モーダルの「保存」ボタンタップで`exercises.sort_order`に一括更新されること（DB永続化）
- **FR-005**: モーダルの「キャンセル」ボタンタップで変更が破棄されること
- **FR-006**: `exercises`テーブルに`sort_order INTEGER NOT NULL`カラムを追加すること（Migration v6）
- **FR-007**: Migration v6で既存種目に`sort_order = rowid`を設定すること（登録順で初期化）
- **FR-008**: 新規カスタム種目作成時は`MAX(sort_order) + 1`を`sort_order`に設定すること
- **FR-009**: `findAll()`クエリを`ORDER BY sort_order ASC`に変更すること
- **FR-010**: 並び替えモーダルはセクション区別なく全種目をフラットリストで表示すること

### Key Entities

- **SortOrder（並び順）**: `exercises.sort_order INTEGER NOT NULL` — 全種目共通の表示順序
- **ReorderModal（並び替えモーダル）**: 全種目をドラッグ&ドロップで並び替えるフルスクリーンモーダル

---

## Success Criteria *(mandatory)*

### Measurable Outcomes

- **SC-001**: 並び替えモーダルで変更・保存後、種目選択画面を再オープンしたときに変更した順序が反映されること
- **SC-002**: アプリ再起動後も変更した並び順が維持されること（DB永続化）
- **SC-003**: 既存のお気に入り・マイ種目・カテゴリ別セクション構造が破壊されないこと（リグレッションなし）
- **SC-004**: Migration v6実行後、既存の全種目に`sort_order`が設定されていること（NULLなし）
- **SC-005**: 新規カスタム種目が常に末尾に追加されること
