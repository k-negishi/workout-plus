# Feature Specification: 登録画面の改善

**Feature Branch**: `20260223-登録画面改善`
**Created**: 2026-02-23
**Status**: Draft
**Issue**: #139

## 背景

登録画面（RecordScreen）における3つのユーザビリティ上の問題を解消する。

1. **データ保持の問題**: 別日・別セッションに遷移した際も以前の入力が引き継がれてしまう
2. **タイマー「完了」ボタンの誤解**: ボタン名が「完了（=保存）」を示唆しているが、実際はセット単位でリアルタイム保存済み
3. **前回セットの日付整合性**: 編集モードや過去日付セッション時に、対象日付より後のレコードが「前回セット」として表示される

---

## User Scenarios & Testing *(mandatory)*

### User Story 1 - 別日セッション開始時の入力状態リセット (Priority: P1)

ユーザーが登録画面でセットを入力後、戻るボタンで離脱し、異なる日付で再度登録画面を開いたとき、前回の入力データが画面に残っていない。

**Why this priority**: データの混入は直接的に記録の正確性を損ない、ユーザーの信頼を失う最も重大な問題。

**Independent Test**: カレンダーから特定日を選択→種目を選択してセット入力→戻る→別日を選択→種目を選択した際に前回の入力が表示されないことを確認。

**Acceptance Scenarios**:

1. **Given** 2026-01-10に登録画面を開きスクワット3セットを入力した状態、 **When** 戻るボタンで離脱して2026-01-11のカレンダー日付から新規登録画面を開く、 **Then** 登録画面はスクワットのセット入力がリセットされた空の状態で表示される
2. **Given** 当日のセッション（in_progressワークアウト）を作成してから戻った状態、 **When** 翌日の新規セッションを開始する、 **Then** 前日の未完了ワークアウトのセットは引き継がれない（新しいワークアウトとして開始される）
3. **Given** 編集モードでワークアウトを開いている状態、 **When** 戻るボタンで離脱、 **Then** 次のセッションはその編集内容を引き継がない

---

### User Story 2 - タイマーボタンの文言・UX改善 (Priority: P2)

ユーザーがワークアウト中にタイマーバーのボタンを操作する際、各ボタンがいつ・何をするのかを直感的に理解できる。「完了」という文言がデータ保存のタイミングと誤解されないようにする。

**Why this priority**: 「完了したら初めて保存される」という誤解は、アプリへの不信感につながる。セット入力はリアルタイム保存であることをUIで明示するべき。

**Independent Test**: タイマー動作中にボタン文言と挙動を確認し、押下後に完了画面（WorkoutSummary）に遷移することを確認。

**Acceptance Scenarios**:

1. **Given** 1件以上のセットを入力した状態でタイマーが動作中、 **When** 終了ボタンを押す、 **Then** 「保存して終了」「記録完了」などの意味が明確な文言が表示され、押下後にワークアウトサマリー画面に遷移する
2. **Given** セットを1件も入力していない状態、 **When** 終了ボタンを確認、 **Then** ボタンは無効化（グレーアウト）されており押下できない
3. **Given** タイマーが動作中、 **When** 終了ボタンを押す前、 **Then** セットデータはすでに保存済みであることがUIから理解できる（例：入力済みセット数の表示、自動保存インジケーター）

---

### User Story 3 - 前回セットの日付整合性改善 (Priority: P3)

「前回のセット」として表示されるデータが、常に「現在のセッション日付以前の直近ワークアウト」に基づいている。編集モードや過去日付入力時でも正確な前回セットが表示される。

**Why this priority**: 前回セットの参照精度はトレーニング計画の根拠となるため正確性が重要。ただし影響がデータ表示のみのため他の問題より優先度は低い。

**Independent Test**: 2026-01-15のワークアウトを編集する際、「前回セット」として2026-01-10のデータが表示され、2026-01-20のデータは表示されないことを確認。

**Acceptance Scenarios**:

1. **Given** スクワットの記録が1/10・1/15・1/20にある状態、 **When** 1/15の過去日付セッションを新規入力または編集する、 **Then** 前回セットとして1/10のデータが表示される（1/20は表示されない）
2. **Given** 当日（2/23）に初めてスクワットを登録する、 **When** 種目を選択、 **Then** 2/23より前の最新ワークアウトのスクワットデータが前回セットとして表示される
3. **Given** 対象日付以前にスクワットの記録が存在しない、 **When** 種目を選択、 **Then** 「前回の記録なし」と表示される

---

### Edge Cases

- **未完了ワークアウト（in_progress）**: 戻るで離脱した未完了ワークアウトは翌日のセッション開始時に引き継がれない
- **同日中の再入力**: 同日に一度セッションを終了し再度登録画面を開いた場合、新規ワークアウトとして開始される（当日追加の継続登録フローは別途Issue #117で管理）
- **編集モードでの前回セット**: 編集対象のワークアウト自身は前回セットの参照から除外する（現行通り）
- **前回セットの日付が現在のセッション日付と同日**: 同日中の別ワークアウトを編集する場合、同日の完了済みワークアウトのセットを参照してよい

---

## Requirements *(mandatory)*

### Functional Requirements

**データリセット**

- **FR-001**: セッション開始時（startSession呼び出し時）に、Zustandストアの全入力状態（種目・セット・タイマー・セッション日付）を完全にリセットしなければならない
- **FR-002**: 過去日付のセッションを開始する際、そのsessionTargetDateはリセット後に再設定しなければならない
- **FR-003**: 戻る操作やセッション離脱後に未完了のワークアウトが残る場合でも、次の新規セッション開始時に前セッションのデータを引き継いではならない

**タイマーボタン文言**

- **FR-004**: タイマーバーの終了ボタン文言を「完了」から「終了」または同等の誤解を招かない文言に変更しなければならない
- **FR-005**: 終了ボタン押下後、WorkoutSummary画面に遷移しなければならない（現行動作を維持）
- **FR-006**: セット入力はボタン押下に関わらずリアルタイム保存される動作を維持しなければならない

**前回セットの日付整合性**

- **FR-007**: 前回セット取得クエリは「現在のセッション日付以前」の完了済みワークアウトから直近1件を取得しなければならない
- **FR-008**: セッション日付が指定されている場合（過去日付入力・編集）、そのセッション日付を基準に「以前」を判定しなければならない
- **FR-009**: セッション日付が未指定の場合（当日リアルタイム入力）、現在日時を基準に「以前」を判定しなければならない
- **FR-010**: 編集対象のワークアウト自身は前回セット取得の検索対象から除外しなければならない（現行通り）

### Key Entities

- **ワークアウトセッション（WorkoutSession）**: 1回のトレーニング記録。status（not_started/in_progress/completed/discarded）と created_at（セッション日付の基準）を持つ
- **セット（WorkoutSet）**: 種目ごとの個々のセット記録。exercise_id・weight・repsを持つ。セッション開始直後から保存される
- **セッション日付（sessionTargetDate）**: カレンダー等から指定された過去日付。未指定の場合は当日として扱う

---

## Success Criteria *(mandatory)*

### Measurable Outcomes

- **SC-001**: 別日のセッションを連続して開始した際に、100%のケースで前セッションの入力データが引き継がれない
- **SC-002**: 終了ボタンの文言変更後、ユーザーが「このボタンを押すまで保存されない」と誤解するリスクが排除される（文言・UIで自動保存を示唆）
- **SC-003**: 過去日付セッション・編集モードにおける前回セット表示が、「対象日付以前の直近レコード」と100%一致する
- **SC-004**: 上記3点の改善を既存の自動テストでカバーし、回帰テストとして恒久化する

---

## 前提条件・仮定

- 「継続登録」フロー（Issue #117：当日ワークアウト継続）は本Issueのスコープ外。当日の2回目以降の追加は別機能として扱う
- タイマーボタンのUIレイアウト変更は最小限にとどめる（文言変更のみでも可）
- 前回セット取得のSQLクエリ改修はRepository層（`usePreviousRecord.ts`）に閉じ込める
