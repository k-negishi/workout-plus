# Feature Specification: 種目選択画面のソート順変更

**Feature Branch**: `20260223-種目選択ソート`
**Created**: 2026-02-23
**Status**: Draft
**GitHub Issue**: #141

## User Scenarios & Testing *(mandatory)*

### User Story 1 - ソート方法を選択して種目リストを並び替える (Priority: P1)

ユーザーが種目選択画面（ExercisePickerScreen）を開いた際、画面上部にソートオプションを選択できるUIが表示される。ユーザーは「名前順」「部位別」「追加日順」「よく使う順」の4つのソート方法から1つを選択でき、選択した順序で種目リストが即座に並び替えられる。

**Why this priority**: 本機能の核心であり、他のユーザーストーリーすべての前提となる。ソート選択UIとリスト表示の連動が実現できれば単体でユーザー価値を提供できる。

**Independent Test**: 種目選択画面でソートボタンをタップし、異なる並び順で種目が表示されることを確認できる。

**Acceptance Scenarios**:

1. **Given** 種目選択画面が開いている, **When** ソートセレクター（ボタン/チップ群）が表示されている, **Then** 「名前順」「部位別」「追加日順」「よく使う順」の4つの選択肢が確認できる
2. **Given** デフォルトの「名前順」が選択されている, **When** 「部位別」をタップする, **Then** 種目リストが部位グループ（胸・背中・脚・肩・二頭・三頭・腹）ごとにセクション分けされ、各セクション内は名前順で表示される
3. **Given** 任意のソートが選択されている, **When** 「追加日順」をタップする, **Then** 最近追加された種目（カスタム・プリセット問わず）から順に一覧表示される
4. **Given** 任意のソートが選択されている, **When** 「よく使う順」をタップする, **Then** これまでのワークアウトで使用回数が多い種目から順に表示される
5. **Given** いずれかのソートを選択している, **When** テキスト検索やカテゴリフィルタを適用する, **Then** 選択中のソート順を維持したまま絞り込み結果が表示される

---

### User Story 2 - ソート設定がセッション中に保持される (Priority: P2)

ユーザーが一度ソート順を変更すると、同一セッション内で種目選択画面を再度開いたときも変更したソート順が維持されている。毎回画面を開くたびにソートをやり直す手間がない。

**Why this priority**: 基本的なUX改善。P1が完成しないと検証できないが、ユーザーの継続的な使いやすさに直結する。

**Independent Test**: ソートを「よく使う順」に変更して画面を閉じ、再度開いたとき「よく使う順」が選択された状態で表示されることを確認する。

**Acceptance Scenarios**:

1. **Given** 「よく使う順」を選択した状態で種目選択画面を閉じる, **When** 同一セッション内で再度種目選択画面を開く, **Then** 「よく使う順」が選択済みの状態でリストが表示される
2. **Given** アプリを完全に終了して再起動する, **When** 種目選択画面を開く, **Then** ソート設定はデフォルト（名前順）にリセットされていても良い（永続化は必須要件外）

---

### User Story 3 - ソートとお気に入り・マイ種目セクションの共存 (Priority: P3)

「名前順」「追加日順」「よく使う順」を選択した場合でも、既存の「お気に入り」「マイ種目」セクションが最上位に優先表示される。「部位別」を選択した場合は部位ごとのセクションに統合される。

**Why this priority**: 既存UIとの整合性を保つためのUX整備。P1・P2が完成後に対応する。

**Independent Test**: お気に入り登録済み種目がある状態で各ソートを選択し、お気に入りセクションの表示位置が期待通りかを確認する。

**Acceptance Scenarios**:

1. **Given** お気に入り登録済みの種目がある状態で「名前順」を選択している, **When** 種目リストが表示される, **Then** 「お気に入り」セクションが最上部、次に「マイ種目」セクション、最後に全種目が名前順で表示される
2. **Given** お気に入り登録済みの種目がある状態で「部位別」を選択する, **When** 種目リストが表示される, **Then** お気に入りもマイ種目も各部位のセクションに含まれて表示される（お気に入りセクションは分離しない）
3. **Given** ワークアウト使用履歴がない場合に「よく使う順」を選択する, **When** 種目リストが表示される, **Then** 全種目を名前順にフォールバックして表示する（空リストは表示しない）

---

### Edge Cases

- 全種目を削除した場合（種目が0件のとき）、各ソート選択でどう表示されるか → 空状態メッセージを表示する
- ワークアウト使用履歴が0件の状態で「よく使う順」を選択した場合 → 名前順でフォールバック表示する
- 検索クエリを入力中にソートを変更した場合 → 検索結果を維持したまま新しいソート順に即座に切り替わる
- カテゴリフィルタ選択中にソートを「部位別」に切り替えた場合 → フィルタを解除して全種目を部位別に表示する（部位フィルタと部位別ソートは冗長なため）

## Requirements *(mandatory)*

### Functional Requirements

- **FR-001**: 種目選択画面にソート選択UIを表示すること（名前順・部位別・追加日順・よく使う順の4種類）
- **FR-002**: ソート選択UIでいずれかのオプションをタップすると、即座に種目リストが選択したソート順で再描画されること
- **FR-003**: 「名前順」選択時は既存の表示（お気に入り→マイ種目→カテゴリ別の各セクション内を名前順）を維持すること
- **FR-004**: 「部位別」選択時は部位グループ単位でセクション化し、各セクション内は名前順にすること。既存のお気に入り・マイ種目セクションは表示しない
- **FR-005**: 「追加日順」選択時は全種目を追加日の新しい順（降順）に並べ、セクション分けはなしで一覧表示すること
- **FR-006**: 「よく使う順」選択時は全ワークアウトにおける使用回数が多い順に並べること。使用履歴が0件の種目は名前順でフォールバック表示すること
- **FR-007**: テキスト検索・カテゴリフィルタとの組み合わせが可能であること。ソート順を維持しながら絞り込みが動作すること
- **FR-008**: 選択されたソート順はセッション内（アプリが起動している間）で保持されること
- **FR-009**: デフォルトのソート順は「名前順」とし、既存の表示挙動を破壊しないこと

### Key Entities

- **SortOption（ソートオプション）**: ソート種別を表す値（名前順 / 部位別 / 追加日順 / よく使う順）
- **ExerciseUsageCount（使用回数）**: 種目IDとワークアウト内での出現回数の対応関係。よく使う順の算出に使用

## Success Criteria *(mandatory)*

### Measurable Outcomes

- **SC-001**: ユーザーがソートオプションをタップしてから1秒以内にリストが新しい順序で表示されること
- **SC-002**: 4つのソートオプションすべてが種目選択画面の1スクロール以内の位置に常に表示されていること
- **SC-003**: ソート変更後もテキスト検索・カテゴリフィルタが正常に動作し、ソート順が維持されること
- **SC-004**: 「よく使う順」の計算が既存のワークアウトデータを正しく反映し、最もよく使う種目が先頭に表示されること
- **SC-005**: デフォルト（名前順）では既存の表示順序が一切変化しないこと（リグレッションなし）
