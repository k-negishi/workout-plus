# Feature Specification: タイマー停止確認モーダル

**Feature Branch**: `004-timer-stop-confirm`
**Created**: 2026-02-22
**Status**: Draft
**Input**: User description: "タイマーのバツボタン押したら、ワークアウトを中止するのではなく、単に時間の計測を辞めるだけにしたい。確認モーダルをだしたい。時間の計測とめたらその日は時間無しでワークアウト登録可能"

## User Scenarios & Testing *(mandatory)*

### User Story 1 - タイマー停止確認モーダルの表示 (Priority: P1)

ユーザーがワークアウト記録中にタイマーバーの × ボタンを押すと、「時間の計測を停止しますか？」という確認モーダルが表示される。
ユーザーは「停止する」または「キャンセル」を選べる。
ワークアウト自体は中止されず、セッションはそのまま継続する。

**Why this priority**: タイマーの × ボタンが現状「ワークアウト全体の中止」として機能しているため、誤操作でデータが失われるリスクがある。最優先で修正すべきUX改善。

**Independent Test**: タイマーが計測中に × ボタンを押すことで確認モーダルが表示され、「キャンセル」を押すとモーダルが閉じてワークアウトが継続していることを確認できる。

**Acceptance Scenarios**:

1. **Given** タイマーが計測中（running）の状態, **When** × ボタンを押す, **Then** 「時間の計測を停止しますか？」確認モーダルが表示される
2. **Given** タイマーが一時停止中（paused）の状態, **When** × ボタンを押す, **Then** 確認モーダルが表示される
3. **Given** タイマーが未開始（notStarted）の状態, **When** × ボタンを押す, **Then** 確認モーダルが表示される（操作の一貫性のため）
4. **Given** 確認モーダルが表示されている, **When** 「キャンセル」を押す, **Then** モーダルが閉じてタイマー状態・ワークアウトセッションは変化しない

---

### User Story 2 - タイマー停止後もワークアウトを継続・登録できる (Priority: P1)

ユーザーが確認モーダルで「停止する」を選ぶと、タイマーの計測が停止され時間がリセットされる。
ただしワークアウトセッション自体は継続し、種目の追加・セット入力・完了登録がすべて可能。
タイマーバーは「時間なし」状態であることを視覚的に示す（経過時間表示の非表示またはグレーアウト）。

**Why this priority**: タイマーを止めた後でもワークアウトを保存できるようにすることが本機能の主目的。US1と合わせてMVPを構成する。

**Independent Test**: タイマー停止後に種目を追加し「完了」ボタンを押すことで、ワークアウトが duration = null（時間なし）として正常に保存されることを確認できる。

**Acceptance Scenarios**:

1. **Given** 確認モーダルが表示されている, **When** 「停止する」を押す, **Then** タイマーが停止・リセットされ、経過時間表示が「時間なし」状態になる
2. **Given** タイマーが停止済み, **When** 種目・セットを追加して「完了」ボタンを押す, **Then** ワークアウトが「時間なし」（duration = null）として保存される
3. **Given** タイマーが停止済み, **When** 「完了」ボタンを押す, **Then** ワークアウトサマリー画面に遷移し、所要時間は「―」または非表示で表示される
4. **Given** タイマーが停止済み, **When** タイマーバーの再生ボタン（▶）を確認する, **Then** ボタンは無効化またはグレー表示になっており、再計測を開始できない

---

### Edge Cases

- タイマーが一度も開始されていない状態（notStarted）で × を押して「停止する」を選んだ場合、状態変化はないがワークアウト継続は可能
- タイマー停止後に「完了」ボタンを押しても、種目が0件の場合はボタンが無効のまま（既存仕様を維持）
- タイマー停止済みのワークアウトがホーム画面・カレンダー画面に表示される際、duration = null を安全に扱い、クラッシュしない

## Requirements *(mandatory)*

### Functional Requirements

- **FR-001**: タイマーバーの × ボタンは、ワークアウトを中止するのではなく、時間計測の停止確認モーダルを表示しなければならない
- **FR-002**: 確認モーダルには「停止する」と「キャンセル」の2つのアクションを含まなければならない
- **FR-003**: 「停止する」を選択した場合、タイマーの経過時間はリセットされ、計測状態は「停止済み（discarded）」に遷移しなければならない
- **FR-004**: タイマーが「停止済み」の状態でも、ワークアウトセッション（種目・セット）は継続して編集・保存できなければならない
- **FR-005**: タイマーが「停止済み」状態でワークアウトを完了した場合、duration（所要時間）は null として保存されなければならない
- **FR-006**: タイマーが「停止済み」状態では、再生ボタン（▶）は無効化または非表示にして、再計測を開始できないようにしなければならない
- **FR-007**: ワークアウトサマリー画面で duration が null の場合、所要時間欄は「―」または非表示にしなければならない

### Key Entities

- **TimerStatus**: タイマーの状態を表す識別子。既存の `notStarted | running | paused` に加え `discarded`（計測を手動停止した）を追加する
- **Workout**: ワークアウト記録エンティティ。`duration_seconds` フィールドが null を許容すること（既存スキーマとの整合確認が必要）

## Success Criteria *(mandatory)*

### Measurable Outcomes

- **SC-001**: × ボタンを押してから確認モーダルが表示されるまで 0.3 秒以内
- **SC-002**: タイマー停止後のワークアウト完了登録がエラーなく成功する（エラー率 0%）
- **SC-003**: 「キャンセル」を押した際にワークアウトデータが一切変更されない（セッション継続）
- **SC-004**: duration = null のワークアウトがホーム・カレンダー・サマリー画面で正常に表示される（クラッシュなし）
