---
description: 利用可能な設計アーティファクトに基づいて、依存関係順のアクション可能なtasks.mdを生成する。
handoffs:
  - label: 整合性を分析
    agent: speckit.analyze
    prompt: プロジェクトの整合性分析を実行してください
    send: true
  - label: 実装を開始
    agent: speckit.implement
    prompt: フェーズごとに実装を開始してください
    send: true
---

## ユーザー入力

```text
$ARGUMENTS
```

ユーザー入力が空でなければ、**必ず**内容を考慮してから進めること。

## 概要

1. **セットアップ**: リポジトリルートから `.specify/scripts/bash/check-prerequisites.sh --json` を実行し、FEATURE_DIRとAVAILABLE_DOCSリストを解析する。全パスは絶対パスであること。引数にシングルクォートを含む場合（例: "I'm Groot"）はエスケープ構文を使用: 例 'I'\''m Groot'（またはダブルクォート: "I'm Groot"）。

2. **設計ドキュメントの読み込み**: FEATURE_DIRから読み込み：
   - **必須**: plan.md（技術スタック、ライブラリ、構成）、spec.md（優先度付きユーザーストーリー）
   - **オプション**: data-model.md（エンティティ）、contracts/（APIエンドポイント）、research.md（技術的決定）、quickstart.md（テストシナリオ）
   - 注意: 全プロジェクトが全ドキュメントを持つわけではない。利用可能なものに基づいてタスクを生成する。

3. **タスク生成ワークフローの実行**：
   - plan.md を読み込み、技術スタック、ライブラリ、プロジェクト構成を抽出
   - spec.md を読み込み、優先度（P1、P2、P3等）付きユーザーストーリーを抽出
   - data-model.md が存在する場合: エンティティを抽出しユーザーストーリーにマッピング
   - contracts/ が存在する場合: エンドポイントをユーザーストーリーにマッピング
   - research.md が存在する場合: セットアップタスク用の技術的決定を抽出
   - ユーザーストーリーごとに整理されたタスクを生成（下記のタスク生成ルール参照）
   - ユーザーストーリーの完了順序を示す依存関係グラフを生成
   - ユーザーストーリーごとの並列実行例を作成
   - タスクの完全性を検証（各ユーザーストーリーに必要な全タスクがあり、独立してテスト可能）

4. **tasks.md の生成**: `.specify/templates/tasks-template.md` を構造として使用し、以下を記入：
   - plan.md からの正しい機能名
   - フェーズ 1: セットアップタスク（プロジェクト初期化）
   - フェーズ 2: 基盤タスク（全ユーザーストーリーのブロッキング前提条件）
   - フェーズ 3+: ユーザーストーリーごとに1フェーズ（spec.md の優先度順）
   - 各フェーズに含む: ストーリーの目標、独立テスト基準、テスト（要求された場合）、実装タスク
   - 最終フェーズ: 仕上げ&横断的関心事
   - 全タスクは厳密なチェックリスト形式に従うこと（下記のタスク生成ルール参照）
   - 各タスクの明確なファイルパス
   - ストーリー完了順序を示す依存関係セクション
   - ストーリーごとの並列実行例
   - 実装戦略セクション（MVP優先、インクリメンタルデリバリー）

5. **レポート**: 生成されたtasks.mdのパスとサマリーを出力：
   - 総タスク数
   - ユーザーストーリーごとのタスク数
   - 特定された並列実行の機会
   - 各ストーリーの独立テスト基準
   - 推奨MVPスコープ（通常はユーザーストーリー1のみ）
   - フォーマット検証: 全タスクがチェックリスト形式（チェックボックス、ID、ラベル、ファイルパス）に従っていることを確認

タスク生成のコンテキスト: $ARGUMENTS

tasks.md は即座に実行可能であること — 各タスクはLLMが追加コンテキストなしで完了できるほど具体的であること。

## タスク生成ルール

**重要**: タスクは独立した実装とテストを可能にするため、ユーザーストーリーごとに整理すること。

**テストはオプション**: テストタスクは機能仕様で明示的に要求された場合、またはユーザーがTDDアプローチを要求した場合のみ生成する。

### チェックリスト形式（必須）

全タスクはこの形式に厳密に従うこと：

```text
- [ ] [TaskID] [P?] [Story?] ファイルパス付きの説明
```

**形式の構成要素**：

1. **チェックボックス**: 必ず `- [ ]` で開始（Markdownチェックボックス）
2. **タスクID**: 実行順の連番（T001、T002、T003...）
3. **[P] マーカー**: 並列実行可能な場合のみ（異なるファイル、未完了タスクへの依存なし）
4. **[Story] ラベル**: ユーザーストーリーフェーズのタスクにのみ必須
   - 形式: [US1]、[US2]、[US3] 等（spec.md のユーザーストーリーにマッピング）
   - セットアップフェーズ: ストーリーラベルなし
   - 基盤フェーズ: ストーリーラベルなし
   - ユーザーストーリーフェーズ: ストーリーラベル必須
   - 仕上げフェーズ: ストーリーラベルなし
5. **説明**: 正確なファイルパス付きの明確なアクション

**例**：

- ✅ 正: `- [ ] T001 実装計画に従ってプロジェクト構造を作成`
- ✅ 正: `- [ ] T005 [P] src/middleware/auth.py に認証ミドルウェアを実装`
- ✅ 正: `- [ ] T012 [P] [US1] src/models/user.py にユーザーモデルを作成`
- ✅ 正: `- [ ] T014 [US1] src/services/user_service.py にUserServiceを実装`
- ❌ 誤: `- [ ] ユーザーモデルを作成`（IDとストーリーラベルが欠落）
- ❌ 誤: `T001 [US1] モデルを作成`（チェックボックスが欠落）
- ❌ 誤: `- [ ] [US1] ユーザーモデルを作成`（タスクIDが欠落）
- ❌ 誤: `- [ ] T001 [US1] モデルを作成`（ファイルパスが欠落）

### タスクの整理

1. **ユーザーストーリーから（spec.md）** — 主要な整理軸：
   - 各ユーザーストーリー（P1、P2、P3...）が独自のフェーズを持つ
   - 関連する全コンポーネントをストーリーにマッピング：
     - そのストーリーに必要なモデル
     - そのストーリーに必要なサービス
     - そのストーリーに必要なエンドポイント/UI
     - テストが要求された場合: そのストーリー固有のテスト
   - ストーリーの依存関係をマーク（ほとんどのストーリーは独立しているべき）

2. **コントラクトから**：
   - 各コントラクト/エンドポイント → それが属するユーザーストーリーにマッピング
   - テストが要求された場合: 各コントラクト → そのストーリーのフェーズで実装前にコントラクトテストタスク [P]

3. **データモデルから**：
   - 各エンティティをそれを必要とするユーザーストーリーにマッピング
   - エンティティが複数のストーリーにサービスする場合: 最も早いストーリーまたはセットアップフェーズに配置
   - リレーション → 適切なストーリーフェーズのサービスレイヤータスク

4. **セットアップ/インフラストラクチャから**：
   - 共有インフラストラクチャ → セットアップフェーズ（フェーズ1）
   - 基盤的/ブロッキングタスク → 基盤フェーズ（フェーズ2）
   - ストーリー固有のセットアップ → そのストーリーのフェーズ内

### フェーズ構成

- **フェーズ 1**: セットアップ（プロジェクト初期化）
- **フェーズ 2**: 基盤（ブロッキング前提条件 — ユーザーストーリーの前に完了必須）
- **フェーズ 3+**: 優先度順のユーザーストーリー（P1、P2、P3...）
  - 各ストーリー内: テスト（要求された場合） → モデル → サービス → エンドポイント → 統合
  - 各フェーズは完全で、独立してテスト可能なインクリメントであること
- **最終フェーズ**: 仕上げ&横断的関心事
