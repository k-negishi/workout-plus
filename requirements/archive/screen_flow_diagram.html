<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Workout+ 画面遷移図</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Noto Sans JP', sans-serif;
            background-color: #f9fafb;
            color: #475569;
            padding: 32px;
            overflow-x: auto;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        header {
            margin-bottom: 32px;
        }

        h1 {
            font-size: 28px;
            font-weight: 700;
            color: #475569;
            margin-bottom: 8px;
        }

        .subtitle {
            font-size: 14px;
            color: #64748b;
        }

        .legend {
            background: white;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 32px;
        }

        .legend-title {
            font-size: 16px;
            font-weight: 600;
            color: #475569;
            margin-bottom: 12px;
        }

        .legend-items {
            display: flex;
            flex-wrap: wrap;
            gap: 16px;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .legend-line {
            width: 40px;
            height: 3px;
            border-radius: 2px;
        }

        .legend-label {
            font-size: 13px;
            color: #64748b;
        }

        .diagram-container {
            background: white;
            border: 1px solid #e2e8f0;
            border-radius: 12px;
            padding: 40px;
            position: relative;
            min-height: 900px;
        }

        svg {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 1;
        }

        .arrow {
            fill: none;
            stroke-width: 2;
            opacity: 0.6;
            transition: opacity 0.2s, stroke-width 0.2s;
        }

        .arrow.highlighted {
            opacity: 1;
            stroke-width: 3;
        }

        .arrow-label {
            font-size: 11px;
            fill: #64748b;
            pointer-events: none;
            opacity: 0.8;
        }

        .marker {
            opacity: 0.6;
            transition: opacity 0.2s;
        }

        .marker.highlighted {
            opacity: 1;
        }

        .screens {
            position: relative;
            z-index: 2;
        }

        .screen {
            position: absolute;
            background: white;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            padding: 12px 16px;
            min-width: 120px;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
        }

        .screen:hover {
            border-color: #4D94FF;
            box-shadow: 0 4px 12px rgba(77, 148, 255, 0.15);
            transform: translateY(-2px);
        }

        .screen.active {
            border-color: #4D94FF;
            background: #E6F2FF;
        }

        .screen-name {
            font-size: 13px;
            font-weight: 600;
            color: #475569;
            margin-bottom: 4px;
        }

        .screen-id {
            font-size: 11px;
            color: #94a3b8;
        }

        .screen-type {
            font-size: 10px;
            color: #64748b;
            margin-top: 4px;
            padding: 2px 6px;
            background: #f1f5f9;
            border-radius: 4px;
            display: inline-block;
        }

        /* 画面グループ別の配置 */
        /* タブ画面（上部横並び） */
        #home { top: 60px; left: 100px; }
        #calendar { top: 60px; left: 280px; }
        #stats { top: 60px; left: 460px; }
        #ai { top: 60px; left: 640px; }

        /* 記録フロー（中央） */
        #record { top: 200px; left: 280px; }
        #picker { top: 340px; left: 140px; }
        #history { top: 340px; left: 420px; }
        #history-full { top: 480px; left: 420px; }
        #summary { top: 340px; left: 280px; }
        #discard-dialog { top: 200px; left: 100px; }

        /* 詳細閲覧・編集（中央右） */
        #workout-detail { top: 200px; left: 700px; }
        #workout-edit { top: 340px; left: 700px; }

        /* 設定系（右下） */
        #settings { top: 200px; left: 920px; }
        #settings-backup { top: 340px; left: 860px; }
        #settings-timer { top: 480px; left: 860px; }
        #settings-unit { top: 620px; left: 860px; }

        /* 遷移種類別の色定義 */
        .type-tab { stroke: #94a3b8; }
        .type-push { stroke: #4D94FF; }
        .type-modal { stroke: #10B981; }
        .type-sheet { stroke: #F59E0B; }
        .type-dialog { stroke: #EF4444; }

        .marker-tab { fill: #94a3b8; }
        .marker-push { fill: #4D94FF; }
        .marker-modal { fill: #10B981; }
        .marker-sheet { fill: #F59E0B; }
        .marker-dialog { fill: #EF4444; }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>Workout+ 画面遷移図</h1>
            <p class="subtitle">16画面 × 遷移マッピング</p>
        </header>

        <div class="legend">
            <div class="legend-title">遷移種類</div>
            <div class="legend-items">
                <div class="legend-item">
                    <div class="legend-line" style="background-color: #94a3b8;"></div>
                    <span class="legend-label">タブ切替</span>
                </div>
                <div class="legend-item">
                    <div class="legend-line" style="background-color: #4D94FF;"></div>
                    <span class="legend-label">プッシュ</span>
                </div>
                <div class="legend-item">
                    <div class="legend-line" style="background-color: #10B981;"></div>
                    <span class="legend-label">フルスクリーンモーダル</span>
                </div>
                <div class="legend-item">
                    <div class="legend-line" style="background-color: #F59E0B;"></div>
                    <span class="legend-label">ボトムシート</span>
                </div>
                <div class="legend-item">
                    <div class="legend-line" style="background-color: #EF4444;"></div>
                    <span class="legend-label">ダイアログ</span>
                </div>
            </div>
        </div>

        <div class="diagram-container">
            <svg id="arrowsSvg" viewBox="0 0 1320 760">
                <defs>
                    <!-- 矢印マーカー定義 -->
                    <marker id="arrow-tab" markerWidth="10" markerHeight="10" refX="9" refY="3" orient="auto" markerUnits="strokeWidth" class="marker marker-tab">
                        <path d="M0,0 L0,6 L9,3 z" fill="#94a3b8" />
                    </marker>
                    <marker id="arrow-push" markerWidth="10" markerHeight="10" refX="9" refY="3" orient="auto" markerUnits="strokeWidth" class="marker marker-push">
                        <path d="M0,0 L0,6 L9,3 z" fill="#4D94FF" />
                    </marker>
                    <marker id="arrow-modal" markerWidth="10" markerHeight="10" refX="9" refY="3" orient="auto" markerUnits="strokeWidth" class="marker marker-modal">
                        <path d="M0,0 L0,6 L9,3 z" fill="#10B981" />
                    </marker>
                    <marker id="arrow-sheet" markerWidth="10" markerHeight="10" refX="9" refY="3" orient="auto" markerUnits="strokeWidth" class="marker marker-sheet">
                        <path d="M0,0 L0,6 L9,3 z" fill="#F59E0B" />
                    </marker>
                    <marker id="arrow-dialog" markerWidth="10" markerHeight="10" refX="9" refY="3" orient="auto" markerUnits="strokeWidth" class="marker marker-dialog">
                        <path d="M0,0 L0,6 L9,3 z" fill="#EF4444" />
                    </marker>
                </defs>
                <!-- 遷移の矢印は JavaScript で描画 -->
            </svg>

            <div class="screens">
                <!-- タブ画面 -->
                <div class="screen" id="home" data-screen="home">
                    <div class="screen-name">ホーム</div>
                    <div class="screen-id">home</div>
                    <div class="screen-type">タブ</div>
                </div>
                <div class="screen" id="calendar" data-screen="calendar">
                    <div class="screen-name">カレンダー</div>
                    <div class="screen-id">calendar</div>
                    <div class="screen-type">タブ</div>
                </div>
                <div class="screen" id="stats" data-screen="stats">
                    <div class="screen-name">統計</div>
                    <div class="screen-id">stats</div>
                    <div class="screen-type">タブ</div>
                </div>
                <div class="screen" id="ai" data-screen="ai">
                    <div class="screen-name">AI</div>
                    <div class="screen-id">ai</div>
                    <div class="screen-type">プッシュ</div>
                </div>

                <!-- 記録フロー -->
                <div class="screen" id="record" data-screen="record">
                    <div class="screen-name">記録</div>
                    <div class="screen-id">record</div>
                    <div class="screen-type">モーダル</div>
                </div>
                <div class="screen" id="picker" data-screen="picker">
                    <div class="screen-name">種目選択</div>
                    <div class="screen-id">picker</div>
                    <div class="screen-type">モーダル</div>
                </div>
                <div class="screen" id="history" data-screen="history">
                    <div class="screen-name">種目別履歴BS</div>
                    <div class="screen-id">history</div>
                    <div class="screen-type">ボトムシート</div>
                </div>
                <div class="screen" id="history-full" data-screen="history-full">
                    <div class="screen-name">種目別履歴FS</div>
                    <div class="screen-id">history-full</div>
                    <div class="screen-type">フルスクリーン</div>
                </div>
                <div class="screen" id="summary" data-screen="summary">
                    <div class="screen-name">完了サマリー</div>
                    <div class="screen-id">summary</div>
                    <div class="screen-type">プッシュ</div>
                </div>
                <div class="screen" id="discard-dialog" data-screen="discard-dialog">
                    <div class="screen-name">破棄確認</div>
                    <div class="screen-id">discard-dialog</div>
                    <div class="screen-type">ダイアログ</div>
                </div>

                <!-- 詳細閲覧・編集 -->
                <div class="screen" id="workout-detail" data-screen="workout-detail">
                    <div class="screen-name">詳細閲覧</div>
                    <div class="screen-id">workout-detail</div>
                    <div class="screen-type">プッシュ</div>
                </div>
                <div class="screen" id="workout-edit" data-screen="workout-edit">
                    <div class="screen-name">詳細編集</div>
                    <div class="screen-id">workout-edit</div>
                    <div class="screen-type">プッシュ</div>
                </div>

                <!-- 設定系 -->
                <div class="screen" id="settings" data-screen="settings">
                    <div class="screen-name">設定</div>
                    <div class="screen-id">settings</div>
                    <div class="screen-type">プッシュ</div>
                </div>
                <div class="screen" id="settings-backup" data-screen="settings-backup">
                    <div class="screen-name">バックアップ設定</div>
                    <div class="screen-id">settings-backup</div>
                    <div class="screen-type">プッシュ</div>
                </div>
                <div class="screen" id="settings-timer" data-screen="settings-timer">
                    <div class="screen-name">タイマー設定</div>
                    <div class="screen-id">settings-timer</div>
                    <div class="screen-type">プッシュ</div>
                </div>
                <div class="screen" id="settings-unit" data-screen="settings-unit">
                    <div class="screen-name">単位設定</div>
                    <div class="screen-id">settings-unit</div>
                    <div class="screen-type">プッシュ</div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // 遷移データ定義
        const transitions = [
            // タブ切替
            { from: 'calendar', to: 'home', type: 'tab', label: 'ホームタブ' },
            { from: 'stats', to: 'home', type: 'tab', label: 'ホームタブ' },
            { from: 'home', to: 'calendar', type: 'tab', label: 'カレンダータブ' },
            { from: 'stats', to: 'calendar', type: 'tab', label: 'カレンダータブ' },
            { from: 'home', to: 'stats', type: 'tab', label: '統計タブ' },
            { from: 'calendar', to: 'stats', type: 'tab', label: '統計タブ' },

            // 記録画面への遷移
            { from: 'home', to: 'record', type: 'modal', label: '[+]ボタン' },
            { from: 'calendar', to: 'record', type: 'modal', label: '[+]ボタン' },
            { from: 'stats', to: 'record', type: 'modal', label: '[+]ボタン' },

            // 記録フロー
            { from: 'record', to: 'picker', type: 'modal', label: '+ 種目を追加' },
            { from: 'picker', to: 'record', type: 'modal', label: '種目選択/×' },
            { from: 'record', to: 'summary', type: 'push', label: '完了ボタン' },
            { from: 'summary', to: 'home', type: 'push', label: '閉じる' },
            { from: 'record', to: 'history', type: 'sheet', label: '種目名タップ' },
            { from: 'history', to: 'history-full', type: 'sheet', label: '詳細を見る' },
            { from: 'history-full', to: 'history', type: 'sheet', label: '← 戻る' },
            { from: 'record', to: 'discard-dialog', type: 'dialog', label: '記録を破棄' },

            // ホームからの遷移
            { from: 'home', to: 'workout-detail', type: 'push', label: 'カードタップ' },
            { from: 'home', to: 'settings', type: 'push', label: 'アバター' },
            { from: 'home', to: 'ai', type: 'push', label: 'AIカード' },

            // カレンダーからの遷移
            { from: 'calendar', to: 'workout-detail', type: 'push', label: 'カードタップ' },

            // 詳細閲覧・編集
            { from: 'workout-detail', to: 'workout-edit', type: 'push', label: '編集ボタン' },

            // 設定からの遷移
            { from: 'settings', to: 'settings-backup', type: 'push', label: 'バックアップ' },
            { from: 'settings', to: 'settings-timer', type: 'push', label: 'インターバル' },
            { from: 'settings', to: 'settings-unit', type: 'push', label: '単位' },

            // 統計からの遷移
            { from: 'stats', to: 'history', type: 'sheet', label: '種目名タップ' }
        ];

        // 画面の中心座標を取得
        function getScreenCenter(screenId) {
            const screen = document.getElementById(screenId);
            const rect = screen.getBoundingClientRect();
            const container = document.querySelector('.diagram-container');
            const containerRect = container.getBoundingClientRect();

            return {
                x: rect.left - containerRect.left + rect.width / 2,
                y: rect.top - containerRect.top + rect.height / 2
            };
        }

        // 曲線の制御点を計算（画面の配置に応じて調整）
        function getControlPoints(from, to) {
            const dx = to.x - from.x;
            const dy = to.y - from.y;
            const distance = Math.sqrt(dx * dx + dy * dy);

            // 距離に応じて曲線の強さを調整
            const curvature = Math.min(distance * 0.3, 60);

            // 垂直方向の遷移の場合は水平方向にカーブ
            if (Math.abs(dx) < 50) {
                return {
                    cp1x: from.x + curvature,
                    cp1y: from.y + dy * 0.3,
                    cp2x: to.x - curvature,
                    cp2y: to.y - dy * 0.3
                };
            }
            // 水平方向の遷移の場合は垂直方向にカーブ
            else if (Math.abs(dy) < 50) {
                return {
                    cp1x: from.x + dx * 0.3,
                    cp1y: from.y + curvature,
                    cp2x: to.x - dx * 0.3,
                    cp2y: to.y - curvature
                };
            }
            // 斜め方向の遷移
            else {
                return {
                    cp1x: from.x + dx * 0.3,
                    cp1y: from.y + dy * 0.1,
                    cp2x: to.x - dx * 0.3,
                    cp2y: to.y - dy * 0.1
                };
            }
        }

        // 矢印を描画
        function drawArrows() {
            const svg = document.getElementById('arrowsSvg');
            const svgNS = 'http://www.w3.org/2000/svg';

            transitions.forEach((transition, index) => {
                const from = getScreenCenter(transition.from);
                const to = getScreenCenter(transition.to);
                const cp = getControlPoints(from, to);

                // パスを作成
                const path = document.createElementNS(svgNS, 'path');
                const pathData = `M ${from.x} ${from.y} C ${cp.cp1x} ${cp.cp1y}, ${cp.cp2x} ${cp.cp2y}, ${to.x} ${to.y}`;
                path.setAttribute('d', pathData);
                path.setAttribute('class', `arrow type-${transition.type}`);
                path.setAttribute('marker-end', `url(#arrow-${transition.type})`);
                path.setAttribute('data-from', transition.from);
                path.setAttribute('data-to', transition.to);
                path.setAttribute('data-index', index);

                svg.appendChild(path);

                // ラベルを追加（曲線の中点付近）
                const t = 0.5; // ベジェ曲線のパラメータ（0.5 = 中点）
                const labelX = Math.pow(1-t, 3) * from.x +
                              3 * Math.pow(1-t, 2) * t * cp.cp1x +
                              3 * (1-t) * Math.pow(t, 2) * cp.cp2x +
                              Math.pow(t, 3) * to.x;
                const labelY = Math.pow(1-t, 3) * from.y +
                              3 * Math.pow(1-t, 2) * t * cp.cp1y +
                              3 * (1-t) * Math.pow(t, 2) * cp.cp2y +
                              Math.pow(t, 3) * to.y;

                const label = document.createElementNS(svgNS, 'text');
                label.setAttribute('x', labelX);
                label.setAttribute('y', labelY - 5);
                label.setAttribute('class', 'arrow-label');
                label.setAttribute('text-anchor', 'middle');
                label.setAttribute('data-from', transition.from);
                label.setAttribute('data-to', transition.to);
                label.textContent = transition.label;

                svg.appendChild(label);
            });
        }

        // ホバー時のハイライト処理
        function setupInteraction() {
            const screens = document.querySelectorAll('.screen');
            const arrows = document.querySelectorAll('.arrow');
            const labels = document.querySelectorAll('.arrow-label');

            screens.forEach(screen => {
                screen.addEventListener('mouseenter', () => {
                    const screenId = screen.dataset.screen;
                    screen.classList.add('active');

                    // 関連する矢印をハイライト
                    arrows.forEach(arrow => {
                        const from = arrow.dataset.from;
                        const to = arrow.dataset.to;

                        if (from === screenId || to === screenId) {
                            arrow.classList.add('highlighted');

                            // 関連するラベルもハイライト
                            labels.forEach(label => {
                                if (label.dataset.from === from && label.dataset.to === to) {
                                    label.style.opacity = '1';
                                    label.style.fontWeight = '600';
                                }
                            });

                            // マーカーもハイライト
                            const marker = document.querySelector(`#arrow-${arrow.classList.contains('type-tab') ? 'tab' : arrow.classList.contains('type-push') ? 'push' : arrow.classList.contains('type-modal') ? 'modal' : arrow.classList.contains('type-sheet') ? 'sheet' : 'dialog'} path`);
                            if (marker && marker.parentElement) {
                                marker.parentElement.classList.add('highlighted');
                            }
                        }
                    });
                });

                screen.addEventListener('mouseleave', () => {
                    screen.classList.remove('active');
                    arrows.forEach(arrow => arrow.classList.remove('highlighted'));
                    labels.forEach(label => {
                        label.style.opacity = '0.8';
                        label.style.fontWeight = 'normal';
                    });
                    document.querySelectorAll('.marker').forEach(marker => {
                        marker.classList.remove('highlighted');
                    });
                });
            });
        }

        // 初期化
        document.addEventListener('DOMContentLoaded', () => {
            drawArrows();
            setupInteraction();
        });

        // ウィンドウリサイズ時に再描画
        window.addEventListener('resize', () => {
            const svg = document.getElementById('arrowsSvg');
            while (svg.firstChild) {
                svg.removeChild(svg.firstChild);
            }
            // defs要素を再追加
            const defs = document.createElementNS('http://www.w3.org/2000/svg', 'defs');
            defs.innerHTML = `
                <marker id="arrow-tab" markerWidth="10" markerHeight="10" refX="9" refY="3" orient="auto" markerUnits="strokeWidth" class="marker marker-tab">
                    <path d="M0,0 L0,6 L9,3 z" fill="#94a3b8" />
                </marker>
                <marker id="arrow-push" markerWidth="10" markerHeight="10" refX="9" refY="3" orient="auto" markerUnits="strokeWidth" class="marker marker-push">
                    <path d="M0,0 L0,6 L9,3 z" fill="#4D94FF" />
                </marker>
                <marker id="arrow-modal" markerWidth="10" markerHeight="10" refX="9" refY="3" orient="auto" markerUnits="strokeWidth" class="marker marker-modal">
                    <path d="M0,0 L0,6 L9,3 z" fill="#10B981" />
                </marker>
                <marker id="arrow-sheet" markerWidth="10" markerHeight="10" refX="9" refY="3" orient="auto" markerUnits="strokeWidth" class="marker marker-sheet">
                    <path d="M0,0 L0,6 L9,3 z" fill="#F59E0B" />
                </marker>
                <marker id="arrow-dialog" markerWidth="10" markerHeight="10" refX="9" refY="3" orient="auto" markerUnits="strokeWidth" class="marker marker-dialog">
                    <path d="M0,0 L0,6 L9,3 z" fill="#EF4444" />
                </marker>
            `;
            svg.appendChild(defs);
            drawArrows();
        });
    </script>
</body>
</html>